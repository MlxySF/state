<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Registration - Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: white; color: #2c3e50; text-decoration: none; border-radius: 5px; margin-bottom: 20px; }
        .back-btn:hover { background: #ecf0f1; }
        .card { background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card h2 { color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .info-item { margin-bottom: 15px; }
        .info-item label { display: block; font-weight: 600; color: #7f8c8d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }
        .info-item .value { color: #2c3e50; font-size: 16px; word-break: break-word; }
        .status { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; display: inline-block; }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.approved { background: #d4edda; color: #155724; }
        .status.rejected { background: #f8d7da; color: #721c24; }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600; transition: 0.3s; }
        .btn-approve { background: #27ae60; color: white; }
        .btn-approve:hover { background: #229954; }
        .btn-reject { background: #e74c3c; color: white; }
        .btn-reject:hover { background: #c0392b; }
        .btn-download { background: #3498db; color: white; }
        .btn-download:hover { background: #2980b9; }
        .btn-secondary { background: #9b59b6; color: white; }
        .btn-secondary:hover { background: #8e44ad; }
        .btn-delete { background: #95a5a6; color: white; }
        .btn-delete:hover { background: #7f8c8d; }
        .image-preview { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px; }
        .signature-preview { max-width: 400px; max-height: 200px; border: 2px solid #3498db; border-radius: 5px; padding: 10px; background: white; display: block; margin-top: 10px; }
        .loading { text-align: center; padding: 60px; color: #7f8c8d; }
        .error { background: #f8d7da; color: #721c24; padding: 20px; border-radius: 5px; margin: 20px 0; }
        .no-image { color: #95a5a6; font-style: italic; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üìÑ Registration Details</h1>
        </div>
    </div>

    <div class="container">
        <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
        
        <div id="loadingIndicator" class="loading">‚è≥ Loading registration details...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="registrationContent" style="display: none;">
            
            <!-- Basic Information -->
            <div class="card">
                <h2>üë§ Personal Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Registration Number</label>
                        <div class="value" id="regNumber">-</div>
                    </div>
                    <div class="info-item">
                        <label>Registration Date</label>
                        <div class="value" id="regDate">-</div>
                    </div>
                    <div class="info-item">
                        <label>Full Name (English)</label>
                        <div class="value" id="nameEn">-</div>
                    </div>
                    <div class="info-item">
                        <label>Full Name (Chinese)</label>
                        <div class="value" id="nameCn">-</div>
                    </div>
                    <div class="info-item">
                        <label>IC Number</label>
                        <div class="value" id="ic">-</div>
                    </div>
                    <div class="info-item">
                        <label>Age</label>
                        <div class="value" id="age">-</div>
                    </div>
                    <div class="info-item">
                        <label>School</label>
                        <div class="value" id="school">-</div>
                    </div>
                    <div class="info-item">
                        <label>Status</label>
                        <div class="value" id="studentStatus">-</div>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="card">
                <h2>üìû Contact Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Phone Number</label>
                        <div class="value" id="phone">-</div>
                    </div>
                    <div class="info-item">
                        <label>Email Address</label>
                        <div class="value" id="email">-</div>
                    </div>
                    <div class="info-item">
                        <label>Parent/Guardian Name</label>
                        <div class="value" id="parentName">-</div>
                    </div>
                    <div class="info-item">
                        <label>Parent/Guardian IC</label>
                        <div class="value" id="parentIc">-</div>
                    </div>
                </div>
            </div>

            <!-- Class Information -->
            <div class="card">
                <h2>ü•ã Class Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Level</label>
                        <div class="value" id="level">-</div>
                    </div>
                    <div class="info-item">
                        <label>Number of Classes</label>
                        <div class="value" id="classCount">-</div>
                    </div>
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <label>Selected Events</label>
                        <div class="value" id="events">-</div>
                    </div>
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <label>Schedule</label>
                        <div class="value" id="schedule">-</div>
                    </div>
                </div>
            </div>

            <!-- Payment Information -->
            <div class="card">
                <h2>üí≥ Payment Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Payment Amount</label>
                        <div class="value" id="paymentAmount">-</div>
                    </div>
                    <div class="info-item">
                        <label>Payment Date</label>
                        <div class="value" id="paymentDate">-</div>
                    </div>
                    <div class="info-item">
                        <label>Payment Status</label>
                        <div class="value"><span class="status" id="paymentStatus">-</span></div>
                    </div>
                </div>
                <div class="info-item" style="margin-top: 20px;">
                    <label>Payment Receipt</label>
                    <div id="paymentReceiptContainer">
                        <img id="paymentReceipt" class="image-preview" style="display: none;" />
                        <span id="noReceipt" class="no-image" style="display: none;">No receipt uploaded</span>
                    </div>
                </div>
            </div>

            <!-- Signature -->
            <div class="card">
                <h2>‚úçÔ∏è Signature</h2>
                <div class="info-item">
                    <label>Applicant Signature</label>
                    <div id="signatureContainer">
                        <img id="signature" class="signature-preview" style="display: none;" alt="Signature" />
                        <span id="noSignature" class="no-image" style="display: none;">No signature available</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card">
                <h2>üîß Actions</h2>
                <div class="action-buttons">
                    <button class="btn btn-download" onclick="downloadSignedAgreement()">üìù Download Signed Agreement</button>
                    <button class="btn btn-approve" id="approveBtn" onclick="updateStatus('approved')">‚úÖ Approve Payment</button>
                    <button class="btn btn-reject" id="rejectBtn" onclick="updateStatus('rejected')">‚ùå Reject Payment</button>
                    <button class="btn btn-delete" onclick="deleteRegistration()">üóëÔ∏è Delete Registration</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        let registrationId = null;
        let registrationData = null;

        // Get registration ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        registrationId = urlParams.get('id');

        if (!registrationId) {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = 'Error: No registration ID provided';
        } else {
            loadRegistration();
        }

        // Helper function to ensure proper base64 data URI format
        function ensureDataUri(base64String, mimeType) {
            if (!base64String || base64String.trim() === '') {
                return null;
            }
            
            // If already has data URI prefix, return as is
            if (base64String.startsWith('data:')) {
                return base64String;
            }
            
            // Add the proper data URI prefix
            return `data:${mimeType};base64,${base64String}`;
        }

        async function loadRegistration() {
            try {
                const response = await fetch(`../api/get_registration.php?id=${registrationId}`);
                const data = await response.json();

                if (data.success && data.registration) {
                    registrationData = data.registration;
                    console.log('Registration data loaded:', {
                        hasSignature: !!registrationData.signature_base64,
                        signatureLength: registrationData.signature_base64 ? registrationData.signature_base64.length : 0,
                        hasReceipt: !!registrationData.payment_receipt_base64,
                        hasPDF: !!registrationData.signed_pdf_base64
                    });
                    displayRegistration(registrationData);
                } else {
                    throw new Error(data.error || 'Failed to load registration');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error loading registration: ' + error.message;
            }
        }

        function displayRegistration(reg) {
            // Personal Information
            document.getElementById('regNumber').textContent = reg.registration_number;
            document.getElementById('regDate').textContent = new Date(reg.created_at).toLocaleString('en-MY');
            document.getElementById('nameEn').textContent = reg.name_en;
            document.getElementById('nameCn').textContent = reg.name_cn || 'N/A';
            document.getElementById('ic').textContent = reg.ic;
            document.getElementById('age').textContent = reg.age;
            document.getElementById('school').textContent = reg.school;
            document.getElementById('studentStatus').textContent = reg.status;

            // Contact Information
            document.getElementById('phone').textContent = reg.phone;
            document.getElementById('email').textContent = reg.email;
            document.getElementById('parentName').textContent = reg.parent_name;
            document.getElementById('parentIc').textContent = reg.parent_ic;

            // Class Information
            document.getElementById('level').textContent = reg.level || 'N/A';
            document.getElementById('classCount').textContent = reg.class_count || 'N/A';
            document.getElementById('events').textContent = reg.events;
            document.getElementById('schedule').textContent = reg.schedule;

            // Payment Information
            document.getElementById('paymentAmount').textContent = 'RM ' + parseFloat(reg.payment_amount).toFixed(2);
            document.getElementById('paymentDate').textContent = reg.payment_date || 'N/A';
            
            const statusEl = document.getElementById('paymentStatus');
            statusEl.textContent = reg.payment_status.toUpperCase();
            statusEl.className = 'status ' + reg.payment_status;

            // Payment Receipt - with proper base64 handling
            const receiptData = ensureDataUri(reg.payment_receipt_base64, 'image/png');
            if (receiptData) {
                const receiptImg = document.getElementById('paymentReceipt');
                receiptImg.onerror = function() {
                    console.error('Failed to load payment receipt image');
                    this.style.display = 'none';
                    document.getElementById('noReceipt').style.display = 'block';
                };
                receiptImg.onload = function() {
                    console.log('Payment receipt loaded successfully');
                };
                receiptImg.src = receiptData;
                receiptImg.style.display = 'block';
            } else {
                document.getElementById('noReceipt').style.display = 'block';
            }

            // Signature - with proper base64 handling
            const signatureData = ensureDataUri(reg.signature_base64, 'image/png');
            if (signatureData) {
                const signatureImg = document.getElementById('signature');
                
                signatureImg.onerror = function() {
                    console.error('Failed to load signature image');
                    console.log('Signature data preview:', reg.signature_base64.substring(0, 100));
                    this.style.display = 'none';
                    document.getElementById('noSignature').style.display = 'block';
                };
                
                signatureImg.onload = function() {
                    console.log('Signature loaded successfully');
                    this.style.display = 'block';
                    document.getElementById('noSignature').style.display = 'none';
                };
                
                signatureImg.src = signatureData;
            } else {
                console.log('No signature data available');
                document.getElementById('noSignature').style.display = 'block';
            }

            // Show/hide action buttons based on status
            if (reg.payment_status === 'approved') {
                document.getElementById('approveBtn').style.display = 'none';
            } else if (reg.payment_status === 'rejected') {
                document.getElementById('rejectBtn').style.display = 'none';
            }

            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('registrationContent').style.display = 'block';
        }

        async function updateStatus(newStatus) {
            const action = newStatus === 'approved' ? 'approve' : 'reject';
            if (!confirm(`Are you sure you want to ${action} this registration?`)) return;

            try {
                const response = await fetch('../api/update_registration.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        id: registrationId, 
                        payment_status: newStatus 
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ Registration ${action}d successfully!`);
                    loadRegistration();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to update status'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error updating registration status');
            }
        }

        async function deleteRegistration() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete this registration? This action cannot be undone!')) return;

            try {
                const response = await fetch('../api/delete_registration.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: registrationId })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Registration deleted successfully');
                    window.location.href = 'dashboard.html';
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to delete'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error deleting registration');
            }
        }

        function downloadSignedAgreement() {
            if (!registrationData || !registrationData.signed_pdf_base64 || registrationData.signed_pdf_base64.trim() === '') {
                alert('‚ö†Ô∏è Signed agreement PDF not available for this registration');
                return;
            }

            try {
                // Ensure proper PDF data URI format
                const pdfData = ensureDataUri(registrationData.signed_pdf_base64, 'application/pdf');
                
                if (!pdfData) {
                    alert('‚ùå Invalid PDF data');
                    return;
                }
                
                // Convert base64 to blob for proper download
                const base64Data = pdfData.split(',')[1];
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                const blob = new Blob([bytes], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Signed_Agreement_${registrationData.registration_number}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                console.log('PDF download initiated successfully');
            } catch (error) {
                console.error('Error downloading signed agreement:', error);
                alert('‚ùå Error downloading signed agreement: ' + error.message);
            }
        }
    </script>
</body>
</html>